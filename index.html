<!DOCTYPE html>
<html lang="en">
<head>
  <title>IST Canteen - Alameda</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>
<body>

  <div class="container">
    <div class="jumbotron">
      <h1>IST Canteen - Alameda</h1>
      <p>Weekly menu: <span id='week-info'></span></p> 
    </div>

    <p>
      <div class="row">
        <div class="col-sm-8">
          <input class="btn btn-default" type="button" value="Refresh" onclick="loadCanteenInfo()">
        </div>
      </div>
    </p>

    <div class="table-responsive ">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
           <tr>
            <th rowspan="2">Menu type</th>
            <th id='monday'>-</th>
            <th id='tuesday'>-</th>
            <th id='wednesday'>-</th>
            <th id='thursday'>-</th>
            <th id='friday'>-</th>
            <th id='saturday'>-</th>
            <th id='sunday'>-</th>
          </tr>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
            <th>Saturday</th>
            <th>Sunday</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">Lunch Soup</th>
            <td id='monday-sopa'>-</td>
            <td id='tuesday-sopa'>-</td>
            <td id='wednesday-sopa'>-</td>
            <td id='thursday-sopa'>-</td>
            <td id='friday-sopa'>-</td>
            <td id='saturday-sopa'>-</td>
            <td id='sunday-sopa'>-</td>
          </tr>
          <tr>
            <th scope="row">Lunch Meet</th>
            <td id='monday-carne'>-</td>
            <td id='tuesday-carne'>-</td>
            <td id='wednesday-carne'>-</td>
            <td id='thursday-carne'>-</td>
            <td id='friday-carne'>-</td>
            <td id='saturday-carne'>-</td>
            <td id='sunday-carne'>-</td>
          </tr>
          <tr>
            <th scope="row">Lunch Fish</th>
            <td id='monday-peixe'>-</td>
            <td id='tuesday-peixe'>-</td>
            <td id='wednesday-peixe'>-</td>
            <td id='thursday-peixe'>-</td>
            <td id='friday-peixe'>-</td>
            <td id='saturday-peixe'>-</td>
            <td id='sunday-peixe'>-</td>
          </tr>
          <tr>
            <th scope="row">Lunch Mass</th>
            <td id='monday-massa'>-</td>
            <td id='tuesday-massa'>-</td>
            <td id='wednesday-massa'>-</td>
            <td id='thursday-massa'>-</td>
            <td id='friday-massa'>-</td>
            <td id='saturday-massa'>-</td>
            <td id='sunday-massa'>-</td>
          </tr>
          <tr>
            <th scope="row">Lunch Macrobiotic</th>
            <td id='monday-macrobiótico'>-</td>
            <td id='tuesday-macrobiótico'>-</td>
            <td id='wednesday-macrobiótico'>-</td>
            <td id='thursday-macrobiótico'>-</td>
            <td id='friday-macrobiótico'>-</td>
            <td id='saturday-macrobiótico'>-</td>
            <td id='sunday-macrobiótico'>-</td>
          </tr>
          <tr>
            <th scope="row">Dinner</th>
            <td id='monday-jantar'>-</td>
            <td id='tuesday-jantar'>-</td>
            <td id='wednesday-jantar'>-</td>
            <td id='thursday-jantar'>-</td>
            <td id='friday-jantar'>-</td>
            <td id='saturday-jantar'>-</td>
            <td id='sunday-jantar'>-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="alert" class="alert alert-warning" role="alert" hidden></div>

  </body>

  <script>
  $(document).ready(loadCanteenInfo);

  var weekdays = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function loadCanteenInfo() {
      readDataFromFile();
      // debugger;
      // processData(fileData);
      // $.ajax({
      //   url: 'https://fenix.tecnico.ulisboa.pt/api/fenix/v1/canteen',
      //   type: 'GET',
      //   dataType: 'jsonp',
      //   error: function(jqXHR, textStatus, errorThrown){ alert("Error: " + textStatus + " => " + errorThrown); },
      //   success: function() {
      //     alert('GET completed: ' + data); 
      //   }
      // });  
    }

    function readDataFromFile() {
      //https://fenix.tecnico.ulisboa.pt/api/fenix/v1/canteen
      //http://codebeautify.org/jsonviewer one liner json

      var filePath = "assets/resources/";
      var filename = "data.json";
      var file = filePath + filename;

      $.ajax({
        dataType: "json",
        url: file,
        success: function(jdata) {
          var json = $.parseJSON(jdata);
          processData(json);
        },
        error: function(err) {
          console.error("error reading from file: " + file);
        }
      });
    }

    function processData(obj) {
          //http://www.textfixer.com/tools/remove-white-spaces.php
          //http://bernhardhaeussner.de/odd/json-escape/
          //delete \n
          
          var pattern = /(\d{2})\/(\d{1,2})\/(\d{4})/;
          var dates=[];

          resetInfo();

          $.each(obj, function(index, element) {
            var day = element.day
            var dateArr = day.split('/');
            
            var dayOfMonth =  dateArr[0];
            if(dayOfMonth.length < 2) {
              dayOfMonth = "0" + dayOfMonth 
            } 

            var month = dateArr[1];
            if(month.length < 2) {
              month = "0" + month 
            } 

            var year = dateArr[2];
            var date = new Date(year + "-" + month + "-" + dayOfMonth);
            var weekday = weekdays[date.getDay()];
            weekday = weekday.toLowerCase();
            $('#' + weekday).html(formatDateString(date))

            dates.push(date);

            var meals = element.meal
            $.each(meals, function(index, element) {
              var meal_type = element.type.toLowerCase()

              var info = element.info
              $.each(info, function(index, element) {
                var name = element.name
                var dish_type = element.type.toLowerCase()

                if(meal_type === "jantar") {
                  if($('#' + weekday + '-' + meal_type).length != 0) {
                    $('#' + weekday + '-' + meal_type).html(name);
                  }
                  else {
                    $('#alert').show();
                    $('#alert').append('<p>' + 'Weird value! Day: ' + day + ', Meal: ' + meal_type +', Dish: ' + dish_type + ', with name: ' + name + '</p>');
                    console.error("Weird value! Day: " + day + ", Meal: " + meal_type +", Dish: " + dish_type + ", with name: " + name);
                  }
                }
                else {
                  if($('#' + weekday + '-' + dish_type).length != 0) {
                    $('#' + weekday + '-' + dish_type).html(name);
                  }
                  else {
                    $('#alert').show();
                    $('#alert').append('<p>' + 'Weird value! Day: ' + day + ', Meal: ' + meal_type +', Dish: ' + dish_type + ', with name: ' + name + '</p>');
                    console.error("Weird value! Day: " + day + ", Meal: " + meal_type +", Dish: " + dish_type + ", with name: " + name);
                  }
                }
              });
            });
          });

          var maxDate = new Date(Math.max.apply(null,dates));
          var minDate = new Date(Math.min.apply(null,dates));

          $('#week-info').html(formatDateString(minDate) + " to " + formatDateString(maxDate))
        }

    function formatDateString(date) {
      return date.getDate() + "/" + months[date.getMonth()] + "/" + date.getFullYear();
    }

    function resetInfo(){
      $('#week-info').html('');
      $('td');
      $('#alert').html('-');
      $('#alert').hide();
    }
</script>

<style>
table, th, td {
    text-align: center;
}
.table>thead>tr>th {
  vertical-align: middle;
}
</style>

</html>
